# Stage 1: Build React frontend
FROM node:18 AS frontend-builder

WORKDIR /client
COPY client/package*.json ./
RUN npm install
COPY client/ ./
RUN npm run build

# Stage 2: Build Go backend
FROM golang:1.25.1 AS backend-builder

WORKDIR /server
COPY server/go.mod server/go.sum ./
RUN go mod download
COPY server/ ./
RUN CGO_ENABLED=0 GOOS=linux go build -o backend .

# Stage 3: Final image
FROM alpine:latest

# Install necessary packages
RUN apk --no-cache add ca-certificates

WORKDIR /app

# Copy Go binary
COPY --from=backend-builder /server/backend .

# Copy React build
COPY --from=frontend-builder /client/dist ./client/dist

RUN chmod +x ./backend

# Optional: for debugging
RUN ls -l /app  

# Expose port
EXPOSE 3003

# Run the Go server
CMD ["./backend"]